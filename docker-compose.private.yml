services:
  usnpw:
    image: ${USNPW_IMAGE:-usnpw:latest}
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=16m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    pids_limit: 256
    environment:
      USNPW_API_HOST: 0.0.0.0
      USNPW_API_PORT: 8080
      USNPW_API_TOKEN_FILE: /run/secrets/usnpw_api_token
      USNPW_API_MAX_CONCURRENT_REQUESTS: 256
      USNPW_API_SOCKET_TIMEOUT_SECONDS: 5
      USNPW_API_AUTH_FAIL_LIMIT: 16
      USNPW_API_AUTH_FAIL_WINDOW_SECONDS: 60
      USNPW_API_AUTH_BLOCK_SECONDS: 300
    secrets:
      - usnpw_api_token
    ports:
      # Bind only to private/local interface unless explicitly exposing wider.
      - "127.0.0.1:8080:8080"
    networks:
      - usnpw_private

secrets:
  usnpw_api_token:
    file: ./secrets/usnpw_api_token.txt

networks:
  usnpw_private:
    internal: true
